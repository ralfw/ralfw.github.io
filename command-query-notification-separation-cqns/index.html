<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Command Query Notification Separation (CQNS) - ralfw-de</title><meta name="description" content="CQS (Command Query Separation) is a well known principle for disentangling method responsibilities in OO software. I had known it for quite some time, but only recently actually have taken it to heart. And now I’m really loving it. I cannot imagine doing without it."><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://ralfw.de/command-query-notification-separation-cqns/"><link rel="alternate" type="application/atom+xml" href="https://ralfw.de/feed.xml"><link rel="alternate" type="application/json" href="https://ralfw.de/feed.json"><meta property="og:title" content="Command Query Notification Separation (CQNS)"><meta property="og:image" content="https://ralfw.de/media/posts/131/DraggedImage-11-1.png"><meta property="og:site_name" content="ralfw-de"><meta property="og:description" content="CQS (Command Query Separation) is a well known principle for disentangling method responsibilities in OO software. I had known it for quite some time, but only recently actually have taken it to heart. And now I’m really loving it. I cannot imagine doing without it."><meta property="og:url" content="https://ralfw.de/command-query-notification-separation-cqns/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@ralfw"><meta name="twitter:title" content="Command Query Notification Separation (CQNS)"><meta name="twitter:description" content="CQS (Command Query Separation) is a well known principle for disentangling method responsibilities in OO software. I had known it for quite some time, but only recently actually have taken it to heart. And now I’m really loving it. I cannot imagine doing without it."><meta name="twitter:image" content="https://ralfw.de/media/posts/131/DraggedImage-11-1.png"><link rel="shortcut icon" href="https://ralfw.de/media/website/favicon.png" type="image/x-icon"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--logo-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--menu-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://ralfw.de/assets/css/style.css?v=c13570ce2327ee7300beba58cfcdd736"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://ralfw.de/command-query-notification-separation-cqns/"},"headline":"Command Query Notification Separation (CQNS)","datePublished":"2019-07-16T17:31","dateModified":"2021-01-28T13:44","image":{"@type":"ImageObject","url":"https://ralfw.de/media/posts/131/DraggedImage-11-1.png","height":1212,"width":860},"description":"CQS (Command Query Separation) is a well known principle for disentangling method responsibilities in OO software. I had known it for quite some time, but only recently actually have taken it to heart. And now I’m really loving it. I cannot imagine doing without it.","author":{"@type":"Person","name":"Ralf Westphal","url":"https://ralfw.de/authors/ralf-westphal/"},"publisher":{"@type":"Organization","name":"Ralf Westphal","logo":{"@type":"ImageObject","url":"https://ralfw.de/media/website/logo-smaller.png","height":53,"width":250}}}</script></head><body><script type="text/javascript">var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/606e06a2f7ce1827093813ae/1f2msm5ed';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();</script><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://ralfw.de/"><img src="https://ralfw.de/media/website/logo-smaller.png" alt="ralfw-de"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://ralfw.de/focus/" target="_self">Focus</a></li><li><a href="https://ralfw.de/approach/" target="_self">Approach</a></li><li class="has-submenu"><a href="https://ralfw.de/trainings/" target="_self" aria-haspopup="true">Trainings</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://ralfw.de/test-first-codierung/" target="_self">Test-first Codierung🇩🇪</a></li><li><a href="https://ralfw.de/softwareentwurf-mit-flow-design/" target="_self">Softwareentwurf mit Flow-Design🇩🇪</a></li><li><a href="https://ralfw.de/software-anforderungsanalyse-mit-slicing/" target="_self">Software Anforderungsanalyse mit Slicing🇩🇪</a></li></ul></li><li><a href="https://ralfw.de/consulting/" target="_self">Consulting</a></li><li><a href="https://ralfw.de/publications/" target="_self">Publications</a></li><li><a href="https://ralfw.de/testimonials/" target="_self">Testimonials</a></li><li class="has-submenu"><a href="https://ralfw.de/" target="_self" aria-haspopup="true">Blogs🇩🇪🇬🇧</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://ralfwestphal.substack.com/" target="_blank">Newsletter @ substack.com</a></li><li><a href="https://ralfw.de/" target="_self">2015.. 🇩🇪🇬🇧</a></li><li><a href="https://blog.ralfw.de/" target="_blank">🌐2007..2015🇩🇪</a></li><li><a href="http://geekswithblogs.net/theArchitectsNapkin/Default.aspx" target="_blank">🌐2008..2015🇬🇧</a></li><li><a href="https://weblogs.asp.net/ralfw" target="_blank">🌐2003..2010🇬🇧</a></li><li><span class="is-separator">─────────</span></li><li><a href="http://soziokratie.ralfw.de/" target="_blank">🌐Zur Soziokratie🇩🇪</a></li><li><a href="https://medium.com/gedankliche-umtriebe" target="_blank">🌐Gedankliche Umtriebe🇩🇪</a></li><li><a href="https://medium.com/personal-flow" target="_blank">🌐Personal Flow🇩🇪</a></li></ul></li><li><a href="https://ralfw.de/about/" target="_self">About</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><form action="https://ralfw.de/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="search..." aria-label="search..." autofocus="autofocus"></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false"><use xlink:href="https://ralfw.de/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://ralfw.de/media/posts/131/DraggedImage-11-1.png" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-2xl.png 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="1212" width="860" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2019-07-16T17:31">16.07.2019</time></div><h1>Command Query Notification Separation (CQNS)</h1><div class="post__meta post__meta--author"><a href="https://ralfw.de/authors/ralf-westphal/" class="feed__author invert">Ralf Westphal</a></div></div></header></div><div class="wrapper post__entry"><p></p><p><a href="https://en.wikipedia.org/wiki/Command%E2%80%93query_separation" target="_blank" rel="noopener">CQS (Command Query Separation)</a> is a well known principle for disentangling method responsibilities in OO software.</p><p></p><p></p><p>I had known it for quite some time, but only recently actually have taken it to heart. And now I’m really loving it. I cannot imagine doing without it. It’s a great guidance when designing single classes or whole service processes.</p><p></p><p></p><p>And then there is <a href="https://martinfowler.com/bliki/CQRS.html" target="_blank" rel="noopener">CQRS</a> which builds on CQS. I like that, too. It’s been a great inspiration.</p><p></p><p></p><p>But <a href="https://ralfw.de/food-truck-architecture-its-all-about-events/">then I felt the need to move beyond it</a>: CQS does not cover the „message reality“ I’m encountering. And CQRS does deliver the flexibility I expected from giving up „the single model“.</p><p></p><p></p><h2>Code structure guided by CQS</h2><p></p><p></p><p>To distinguish between Commands and Queries is a great guidance for structuring code. It’s a form of outside-in design, I’d say: You’re looking at the interactions of users (or more generally: the environment) with a system by sending/receiving messages and from that derive a certain structure.</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2656"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-15.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-15-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-15-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-15-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-15-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-15-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-15-2xl.png 1600w" alt="" width="528" height="222"></figure></figure></div><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2647"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-1-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-1-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-1-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-1-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-1-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-1-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-1-1-2xl.png 1600w" alt="" width="526" height="248"></figure></figure></div><p></p><p></p><p>Example: A player makes a move in a Tic Tac Toe game application.</p><p></p><p></p><p>Technically that means a user sends a message to the application with data about the move and receives back a message telling her the new game state.</p><p></p><p></p><p>Or more specifically this is a request for a certain behavior expressed in a response plus a change to some internal state.</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2649"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-2-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-2-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-2-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-2-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-2-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-2-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-2-1-2xl.png 1600w" alt="" width="531" height="250"></figure></figure></div><p></p><p></p><p>The frontend first is used as an editor for the request message. A player certainly does not want to type in a JSON document but rather would like to just click on a cell on some visual game board.</p><p></p><p></p><p>And then the frontend is used as a projector for the response message. A player certainly does not want to interpret a JSON document but rather would like to see the game state rendered as a visual game board.</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2648"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-3-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-3-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-3-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-3-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-3-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-3-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-3-1-2xl.png 1600w" alt="" width="651" height="179"></figure></figure></div><p></p><p></p><p>The domain or game logic itself is encapsulated in the backend with which the frontend is conversing only through messages. <a href="https://ralfw.de/sleepy-hollow-architecture-no-application-should-be-without-it/">Frontend and backend don’t should share state, in my view</a>.</p><p></p><p></p><p>So far so normal. A request is transformed into a state change plus a response. All the necessary logic is a big lump.</p><p></p><p></p><p>However, when applying the CQS to this, the request-response message flow can be dissected into a command followed by a query:</p><p></p><p></p><ul><li>First the command orders the backend to execute the move; the internal state of the backend is changed. This order of course is only carried out if the move is valid and the state’s consistency is not compromised.</li><li>Then the query asks the backend for a description of its internal state.</li></ul><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2651"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-4-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-4-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-4-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-4-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-4-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-4-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-4-1-2xl.png 1600w" alt="" width="652" height="273"></figure></figure></div><p></p><p></p><p>What has been a single lump of logic now is two smaller lumps of logic. How cool is that? And all this without much creativity. The user’s requirement guided the design. Software development just needs to listen.</p><p></p><p></p><p>The tangible outcomes of a CQS-guided analysis are:</p><p></p><p></p><ul><li>A command message (data structure)</li><li>A query result message (data structure)</li><li>A query message (data structure; maybe only for internal use)</li><li>A command status message (data structure; maybe only for internal use)</li><li>A command handler (function)</li><li>A query handler (function)</li><li>A request handler (function; optional for hiding the command and query handler from the frontend for less traffic between frontend and backend)</li></ul><p></p><p></p><p>I like this almost mechanically generated basic structure for my source code. It makes me focus more on the conversation with the user/customer because it’s from there I gain valuable first insights about the software design.</p><p></p><p></p><h2>Message structure freed up by Event-Orientation</h2><p></p><p></p><p>This is, what CQS does already. It’s a great help, but still leaves something to be desired.</p><p></p><p></p><p>What I found quite difficult for a long time was „message design“. How should messages look like, what structure should they have? How should this structure look like compared to the internal domain model?</p><p></p><p></p><p>CQS does not have an answer to that. CQRS on the other hand suggested to take it easier: there could be two models, one for commands and another one for queries.</p><p></p><p></p><p>But still I felt compelled to find the one model for handling commands, and the other one model for satisfying queries.</p><p></p><p></p><p>It took me a while to let go of that restriction.</p><p></p><p></p><p>Today, with <a href="https://ralfw.de/food-truck-architecture-its-all-about-events/">Event-Orientation (EO)</a> I don’t feel any restriction anymore. And I don’t feel I need to get „it“ right anymore „once and for all“.</p><p></p><p></p><p>The internal state of an application is not kept in a single (or two or three) data models anymore. I allow myself to program „model free“ or „schemaless“.</p><p></p><p></p><blockquote class="wp-block-quote"><p>The model is dead! Long live the model multitude!</p></blockquote><p></p><p></p><p>Each and every message is handled individually and is supported by the best model I can think of for that single purpose. With EO I feel free to let message structures be preliminary. They can be honed for consumption by the frontend; the backend then is a true service by catering to the needs of its client. Or message structures can be more palatable for the backend; the frontend then is more of a „slave“ to the provider of the core application behavior, the backend.</p><p></p><p></p><p>I remember how discussions about message structure took up quite some time during modelling sessions. Not anymore. Because there is no question anymore about how much a message model might couple frontend and backend.</p><p></p><p></p><p>There simply is no domain model anymore in the backend. There cannot be any coupling. Whatever a message carries is a projection or something that needs projection. It’s not some form of copy or part of a domain model.</p><p></p><p></p><p>Message structures are freed up by EO to look how they want. The internal state of an EO-based backend is something completely different: a stream of events.</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2652"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-5-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-5-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-5-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-5-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-5-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-5-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-5-1-2xl.png 1600w" alt="" width="441" height="463"></figure></figure></div><p></p><p></p><p>To change the state through a command it has to be translated into a collection of events.</p><p></p><p></p><p>And to query the state the events in the stream have to be aggregated and projected into a result.</p><p></p><p></p><p>The proposition of EO is that such translations and aggregations/projections are all separate. By default they don’t share anything. No coupling, no dependency between them - except for the one event stream.</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2655"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-6-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-6-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-6-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-6-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-6-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-6-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-6-1-2xl.png 1600w" alt="" width="597" height="403"></figure></figure></div><p></p><p></p><p>That makes message processing in both directions cheap. And it allows for independent development. EO slices an application not only into services but into message processing pipelines each catering to just a single message.</p><p></p><p></p><p>Deciding today that the TicTacToe game state query result should look like this, and tomorrow changing the decision to let it look like that is comparatively easy. It has no impact on some comprehensive domain model relevant to many messages.</p><p></p><p></p><p>The contract between message pipelines are just event data types. They are the core representation of the domain. <strong>Look at the events and you know what the domain is about. Events are telling a story about what is happening, what is deemed important, what the causal sequences are.</strong></p><p></p><p></p><p>And this <a href="https://ralfw.de/event-sourcing-for-constructivist-software/">can be interpreted in a million ways</a>, or at least as many ways as there are incoming message types to handle.</p><p></p><p></p><h2>Notifications as ambient messages</h2><p></p><p></p><p>CQS primarily distinguishes two kinds of messages: commands and queries.</p><p></p><p></p><p>That’s incoming messages. How about outgoing ones? I’d like to make explicit also two respective outgoing messages: command status and query result. Command status messages might be quite simple and generic (success vs failure), but query results surely are of very different form and need careful design.</p><p></p><p></p><p>However, in my experience there is a fifth message type. It’s particular because it’s not a request. Commands and queries stand for bidirectional message flow: a client sends a request (command or query) and expects a response (command status or query result).</p><p></p><p></p><p>Sometimes, though, messages are not produced with a certain expectation for a behavior of another (part of) a system. Sometimes messages are just „utterances“ of a system broadcast „to whom it may concern“.</p><p></p><p></p><p>I call such messages <em>notifications</em>.</p><p></p><p></p><p>Usually the name for them is „event“ with a prefix or suffix (like „domain event“). But that clashes with the data stored in an event stream inside of a system. I don’t like such homonymes.</p><p></p><p></p><p>„Notification“ is a term everyone is familiar with: we are notified about emails arriving in our inboxes or new messages in a Slack channel or of an overdue backup etc.</p><p></p><p></p><p>A lot of applications are broadcasting notifications to inform us about something that has happened/changed. And we are free to subscribe to such notifications. Some we are interested in, some not.</p><p></p><p></p><p>If we receive a notification we might react, eg. open the mail client to check our inbox. But the broadcasting application did not request such a reaction.</p><p></p><p></p><p>Notifications are one way messages. Software broadcasts them through some channel/medium as outgoing notifications. And other software might subscribe to a channel/medium to receive notifications from other software as incoming messages.</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2653"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-7-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-7-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-7-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-7-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-7-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-7-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-7-1-2xl.png 1600w" alt="" width="498" height="263"></figure></figure></div><p></p><p></p><p>I call notifications <em>ambient messages</em> because they „float around in the environment“ and are not directed. They have a source, but no destination.</p><p></p><p></p><p>From that follows there is no guarantee that a notification will be handled at all. Notifications thus cannot carry requests. Their purpose solely is to inform about something that happened. They make a statement about the originating system - for others to possibly care for.</p><p></p><p></p><p>Notifications might be more relevant in distributed systems. Nevertheless I think they are a very general concept and thus should be included in the CQS principle. Hence I propose to expand it to:</p><p></p><p></p><blockquote class="wp-block-quote"><p>CQNS: Command Query Notification Separation principle</p></blockquote><p></p><p></p><p>The form of notifications is considerably different (being one-way messages). And their processing is different, too, I think.</p><p></p><p></p><ol><li>Notifications do not query state, because there would be no receiver for a query result.</li><li>Notifications do not change state; that’s what commands are for.</li><li><strong>The single responsibility of incoming notifications is to cause commands to be executed inside a receiver.</strong> However the command status messages generated by the triggered commands are not delivered to the originator of the notification.</li></ol><p></p><p></p><p>So much for incoming notifications.</p><p></p><p></p><p>But where do outgoing notifications come from?</p><p></p><p></p><ul><li><strong>Outgoing notifications are generated during command processing.</strong> Only commands change state, and notifications are signalling state change.</li></ul><p></p><p></p><p>Notifications help to further structure code from the outside-in:</p><p></p><p></p><ul><li>Handling incoming notifications requires logic to translate them into commands.</li><li>Command processing consists not only of<ol><li>model generation,</li><li>command validation,</li><li>event generation,</li><li>but also of generating outgoing notifications.</li></ol></li></ul><p>That, to me, makes requirements analysis yet easier and delivers more input for further software design.</p><p></p><p></p><p>In a gaming scenario there could be two services: one for playing a game like TicTacToe and one for keeping a score board.</p><p></p><p></p><p>Both services could be connected in a request/response manner, for example, for registering the score of a finished game: the TicTacToe service could send a command to the score board service to inform it of another finished game and who has won. But why couple the services so tightly? The TicTacToe service would now depend on another service, it could not do its job without the other.</p><p></p><p></p><p>Instead a notification can be used to more loosely couple both service. With a notification they would not even know of each other.</p><p></p><p></p><ul><li>The TicTacToe service would broadcast a notification when a game finishes, e.g. by writing it to a queue hosted by some infrastructure.</li><li>The score board service would subscribe to „game over“ notifications arriving in a queue hosted by some infrastructure.</li></ul><p></p><p></p><p>One service’s outgoing notification is another service’s incoming notification.</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2657"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-8-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-8-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-8-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-8-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-8-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-8-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-8-1-2xl.png 1600w" alt="" width="618" height="390"></figure></figure></div><p></p><p></p><h2>Anatomy of a backend</h2><p></p><p></p><p>To me the beauty of CQNS + EO is a very straightforward and generic basic software structure. And in that it’s easy to independently focus on (comparatively) small functional units.</p><p></p><p></p><h3>Message-oriented requirements analysis</h3><p></p><p></p><p>Designing software is helped by applying this pattern. But also analysis is helped because it’s guided by the message hierarchy:</p><p></p><p></p><ul><li>Messages<ul><li>Incoming/outgoing<ul><li>Request (outgoing) -&gt; Response (incoming)<ul><li>Command -&gt; Command Status</li><li>Query -&gt; Query Result</li></ul></li><li>Notification<ul><li>Incoming: Notification -&gt; Commands</li><li>Outgoing</li></ul></li></ul></li><li>Event (internal)</li></ul></li></ul><p></p><p></p><p>My approach to software development is outside-in: I start at the surface of a software system and ask „How do users want to interact with the system?“ Requests with their responses are the primary answer to that.</p><p></p><p></p><p>Next I ask to what the software system should react in addition. Incoming notifications are the answer to that.</p><p></p><p></p><p>Then from command requests I derive the internal events to be stored in the event stream.</p><p></p><p></p><p>Next I try to balance the events found with what query requests might deem helpful to get from the event stream.</p><p></p><p></p><p>(If you’re a fan of <a href="https://en.wikipedia.org/wiki/Event_storming" target="_blank" rel="noopener">Event Storming</a> you might prefer to start with events and work your way „up“ to incoming/outgoing messages. That’s fine for me, too. That’s serving the same goal. If you find it easier that way around, why not?)</p><p></p><p></p><p>Finally I’m concerned with outgoing notifications generated by command request processing.</p><p></p><p></p><p>What I’m not really interested in anymore, though, is „the one“ internal domain data structure. I’m not trying to figure out how the domain can be represented in a comprehensive data model.</p><p></p><p></p><p>For a long, long that had been my primary concern. I was fixated on „the one“ domain data model. I wanted to represented „the world“ in software.</p><p></p><p></p><p>But those days are gone now!</p><p></p><p></p><h3>Coloring the design blueprint mandala</h3><p></p><p></p><p>Once I’ve gotten the messages down I can work on them one by one. It’s like eating a pizza slice by slice.</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2646"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-9-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-9-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-9-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-9-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-9-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-9-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-9-1-2xl.png 1600w" alt="" width="577" height="414"></figure></figure></div><p></p><p></p><p>Each slice being a message handling pipeline. And the pizza crust being a tranceiver which receives incoming messages from the environment and sends/broadcasts outgoing messages to the environment.</p><p></p><p></p><p>The structure of all the pipeline slices is the same; each consists of three segments (and is attached to the event store at the center):</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2654"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-10-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-10-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-10-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-10-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-10-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-10-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-10-1-2xl.png 1600w" alt="" width="477" height="292"></figure></figure></div><p></p><p></p><p>So for each message I can design the following step by step:</p><p></p><p></p><ol><li>Define the message context, i.e. all the relevant events</li><li>Design the message context model</li><li>Design how the message context model should be loaded and queried before message processing</li><li>Design how the message should be processed in light of the message context model<ul><li>Command<ul><li>Design how to generate events from the message in light of the message context model</li><li>Design how to generate outgoing notifications from the message</li></ul></li><li>Query<ul><li>Design how to generate the query result from the message context model in light of the message</li></ul></li><li>Notification<ul><li>Design how to generate commands from the message in light of the message context model</li></ul></li></ul></li><li>Design how the message context model should be updated</li></ol><p></p><p></p><p>To me that feels very guided, almost like a meditative activity (if not a boring one). It’s like coloring a mandala area by area…</p><p></p><p></p><div class="wp-block-image"><figure class="aligncenter"><figure class="wp-image-2650"><img loading="lazy" src="https://ralfw.de/media/posts/131/DraggedImage-11-1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-xs.png 300w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-sm.png 480w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-md.png 768w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-lg.png 1024w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-xl.png 1360w, https://ralfw.de/media/posts/131/responsive/DraggedImage-11-1-2xl.png 1600w" alt="" width="545" height="768"></figure></figure></div><p></p><p></p><h2>Summary</h2><p></p><p></p><p>Refining the CQS to CQNS and being grounded in Event-Orientation really helps me progressing through software development in a very straightforward manner.</p><p></p><p></p><p>Sure, there are still challenges to master. Sure, especially processing messages still can be tough.</p><p></p><p></p><p>With CQNS + EO, however, I’m relieved of a lot of confusing stuff around that. I find it much, much easier to focus on the important things.</p><p></p><p></p><ul><li>I’m not wasting energy on asking myself „How to start development?“</li><li>I’m not wasting energy on „getting the one model right“.</li><li>I’m not wasting energy on designing structures which should not differ from software to software anyway.</li></ul><p></p><p></p><p>Yes, I believe there is a basic anatomy to all software. Like there is a basic anatomy to all animals. And that basic anatomy is more fine grained than the usual architectural pattern suggest. And it still leaves room and freedom for all the incredibly complicated stuff you have to implement, don’t worry.</p><p></p><p></p><p>I’d even say: By giving software a basic anatomy we’re set free to focus on the really important things much more. CQNS and EO, to me, are part of that anatomical blueprint.</p><p></p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on 28.01.2021</p><ul class="post__tag"><li><a href="https://ralfw.de/tags/event-orientation/">Event-Orientation</a></li></ul><div class="post__share"></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://ralfw.de/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://ralfw.de/against-pseudo-wisdom/" class="invert post__nav-link" rel="prev"><span>Previous</span> Against pseudo-wisdom</a></div><div class="post__nav-next"><a href="https://ralfw.de/hamburg-style-tdd/" class="invert post__nav-link" rel="next"><span>Next</span> Hamburg Style TDD </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://ralfw.de/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav></main><footer class="footer"><div class="footer__copyright"><p>One Man Think Tank @ Nomad Nation OOD - Sofia, Bulgaria - <a href="../../../../../../imprint">Imprint</a> - <a href="../../../../../../data-privacy-policy">Data Privacy Policy</a></p></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://ralfw.de/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://ralfw.de/assets/js/scripts.min.js?v=f4c4d35432d0e17d212f2fae4e0f8247"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>